<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #2c5282;
            color: white;
            padding: 2rem 0;
            height: 100vh;
            position: fixed;
        }
        
        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 1.5rem;
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .nav-links {
            list-style: none;
        }
        
        .nav-links li {
            margin-bottom: 0.5rem;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover,
        .nav-links a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-links .badge {
            background-color: #e53e3e;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            margin-left: auto;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 2rem;
            margin-left: 250px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .dashboard-header h1 {
            font-size: 1.875rem;
            color: #2c5282;
        }
        
        .dashboard-header .welcome {
            font-size: 1rem;
            color: #4a5568;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        
        .stat-card h3 {
            font-size: 0.875rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c5282;
        }
        
        /* Tabs System */
        .tabs {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .tab-header {
            display: flex;
            background-color: #edf2f7;
        }
        
        .tab-btn {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #2c5282;
            border-bottom-color: #2c5282;
            background-color: white;
        }
        
        .tab-btn .badge {
            background-color: #e53e3e;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .tab-content {
            padding: 1.5rem;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Working Hours Form */
        .working-hours-form {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .working-hours-form h3 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #2c5282;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .btn {
            background-color: #3182ce;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2c5282;
        }
        
        .btn-danger {
            background-color: #e53e3e;
        }
        
        .btn-danger:hover {
            background-color: #c53030;
        }
        
        /* Working Hours Display */
        .working-hours-display {
            margin-top: 2rem;
        }
        
        .working-hours-display h3 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #2c5282;
        }
        
        .hours-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .hours-table th,
        .hours-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        
        .hours-table th {
            background-color: #edf2f7;
            font-weight: 500;
            color: #4a5568;
        }
        
        /* Appointments List */
        .appointment-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .appointment-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border-left: 4px solid #3182ce;
        }
        
        .appointment-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: #2c5282;
        }
        
        .appointment-card p {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        
        .appointment-card .time {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .appointment-card .status {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .appointment-card .status.pending {
            background-color: #fed7d7;
            color: #e53e3e;
        }
        
        .appointment-card .status.confirmed {
            background-color: #c6f6d5;
            color: #38a169;
        }
        
        .appointment-card .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .appointment-card .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Patient Treatment Cards */
        .patient-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border-left: 4px solid #38a169;
            margin-bottom: 1.5rem;
        }
        
        .patient-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: #2c5282;
        }
        
        .patient-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .patient-info p {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        
        .treatment-history {
            margin-top: 1.5rem;
        }
        
        .treatment-entry {
            border-left: 2px solid #3182ce;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        
        .treatment-entry p {
            color: #4a5568;
        }
        
        .treatment-date {
            font-size: 0.875rem;
            color: #718096;
        }
        
        /* Treatment Template Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            color: #2c5282;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-filter input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }
        
        .empty-state p {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Dr. Smith</h2>
                <p>Orthopedic Specialist</p>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="active" data-tab="dashboard">Dashboard</a></li>
                <li><a href="#" data-tab="appointments">Appointments <span class="badge" id="pendingAppointmentsBadge">0</span></a></li>
                <li><a href="#" data-tab="upcoming">Upcoming <span class="badge" id="upcomingAppointmentsBadge">0</span></a></li>
                <li><a href="#" data-tab="treatment">In Treatment <span class="badge" id="inTreatmentBadge">0</span></a></li>
                <li><a href="#" data-tab="treated">Treated <span class="badge" id="treatedBadge">0</span></a></li>
                <li><a href="index.html">Logout</a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="dashboard-header">
                <div>
                    <h1>Doctor Dashboard</h1>
                    <p class="welcome">Welcome back, Dr. Smith</p>
                </div>
                <div class="date" id="currentDate"></div>
            </div>
            
            <!-- Dashboard Content -->
            <div class="tab-pane active" id="dashboard">
                <!-- Stats Overview -->
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Appointments</h3>
                        <div class="stat-value" id="totalAppointments">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Appointments</h3>
                        <div class="stat-value" id="pendingAppointmentsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Upcoming Appointments</h3>
                        <div class="stat-value" id="upcomingAppointmentsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Patients in Treatment</h3>
                        <div class="stat-value" id="inTreatmentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Patients</h3>
                        <div class="stat-value" id="totalPatients">0</div>
                    </div>
                </div>
                
                <!-- Working Hours Management -->
                <div class="working-hours-form">
                    <h3>Set Your Working Hours</h3>
                    <form id="workingHoursForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dayOfWeek">Day of Week</label>
                                <select id="dayOfWeek" required>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                    <option value="Sunday">Sunday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" required>
                            </div>
                            <div class="form-group">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">Add Working Hours</button>
                    </form>
                    
                    <div class="working-hours-display">
                        <h3>Current Working Hours</h3>
                        <table class="hours-table">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="workingHoursTable">
                                <!-- Working hours will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Appointments Tab -->
            <div class="tab-pane" id="appointments">
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="pendingAppointments">
                        Pending Appointments <span class="badge" id="pendingAppointmentsTabBadge">0</span>
                    </button>
                </div>
                
                <div class="tab-content">
                    <div class="tab-pane active" id="pendingAppointments">
                        <div class="search-filter">
                            <input type="text" id="pendingAppointmentsSearch" placeholder="Search patients...">
                        </div>
                        
                        <div class="appointment-list" id="pendingAppointmentsList">
                            <!-- Pending appointments will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Appointments Tab -->
            <div class="tab-pane" id="upcoming">
                <div class="search-filter">
                    <input type="text" id="upcomingAppointmentsSearch" placeholder="Search patients...">
                </div>
                
                <div class="appointment-list" id="upcomingAppointmentsList">
                    <!-- Upcoming appointments will be added here dynamically -->
                </div>
            </div>
            
            <!-- In Treatment Tab -->
            <div class="tab-pane" id="treatment">
                <div class="search-filter">
                    <input type="text" id="inTreatmentSearch" placeholder="Search patients...">
                </div>
                
                <div id="inTreatmentList">
                    <!-- Patients in treatment will be added here dynamically -->
                </div>
            </div>
            
            <!-- Treated Tab -->
            <div class="tab-pane" id="treated">
                <div class="search-filter">
                    <input type="text" id="treatedSearch" placeholder="Search patients...">
                </div>
                
                <div id="treatedList">
                    <!-- Treated patients will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Treatment Template Modal -->
    <div class="modal" id="treatmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="treatmentModalTitle">Create Treatment Plan</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="treatmentForm">
                    <input type="hidden" id="patientId">
                    <input type="hidden" id="appointmentId">
                    
                    <div class="form-group">
                        <label for="diagnosis">Diagnosis</label>
                        <input type="text" id="diagnosis" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="treatmentPlan">Treatment Plan</label>
                        <textarea id="treatmentPlan" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendations">Recommendations</label>
                        <textarea id="recommendations" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="medications">Medications (if any)</label>
                        <textarea id="medications" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="followUpDate">Follow-up Date (if needed)</label>
                        <input type="date" id="followUpDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="saveTreatment">Save Treatment</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const tabButtons = document.querySelectorAll('[data-tab]');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const currentDateEl = document.getElementById('currentDate');
        
        // Initialize current date
        const now = new Date();
        currentDateEl.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Handle tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Remove active class from all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Add active class to current tab
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Working Hours Functionality
        const workingHoursForm = document.getElementById('workingHoursForm');
        const workingHoursTable = document.getElementById('workingHoursTable');
        
        // Load working hours from localStorage
        function loadWorkingHours() {
            const workingHours = JSON.parse(localStorage.getItem('workingHours') || '[]');
            workingHoursTable.innerHTML = '';
            
            if (workingHours.length === 0) {
                workingHoursTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">No working hours set yet. Add your availability above.</td>
                    </tr>
                `;
                return;
            }
            
            workingHours.forEach((hour, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${hour.day}</td>
                    <td>${formatTime(hour.startTime)}</td>
                    <td>${formatTime(hour.endTime)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" data-index="${index}">Remove</button>
                    </td>
                `;
                workingHoursTable.appendChild(row);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.btn-danger[data-index]').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeWorkingHours(index);
                });
            });
        }
        
        // Format time for display
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const formattedHour = hour % 12 || 12;
            return `${formattedHour}:${minutes} ${ampm}`;
        }
        
        // Add working hours
        workingHoursForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const day = document.getElementById('dayOfWeek').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // Validate inputs
            if (!day || !startTime || !endTime) {
                alert('Please fill all fields');
                return;
            }
            
            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }
            
            // Get existing working hours
            const workingHours = JSON.parse(localStorage.getItem('workingHours') || '[]');
            
            // Check for overlapping hours on the same day
            const sameDay = workingHours.filter(hour => hour.day === day);
            for (const hour of sameDay) {
                if (
                    (startTime >= hour.startTime && startTime < hour.endTime) ||
                    (endTime > hour.startTime && endTime <= hour.endTime) ||
                    (startTime <= hour.startTime && endTime >= hour.endTime)
                ) {
                    alert('The selected time overlaps with existing working hours for this day');
                    return;
                }
            }
            
            // Add new working hours
            workingHours.push({
                day,
                startTime,
                endTime
            });
            
            // Sort by day of week
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            workingHours.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));
            
            // Save to localStorage
            localStorage.setItem('workingHours', JSON.stringify(workingHours));
            
            // Reset form and reload table
            workingHoursForm.reset();
            loadWorkingHours();
            
            // Update available slots
            generateAvailableSlots();
        });
        
        // Remove working hours
        function removeWorkingHours(index) {
            const workingHours = JSON.parse(localStorage.getItem('workingHours') || '[]');
            workingHours.splice(index, 1);
            localStorage.setItem('workingHours', JSON.stringify(workingHours));
            loadWorkingHours();
            
            // Update available slots
            generateAvailableSlots();
        }
        
        // Generate available time slots based on working hours
        function generateAvailableSlots() {
            const workingHours = JSON.parse(localStorage.getItem('workingHours') || '[]');
            const appointmentDuration = 30; // minutes
            const availableSlots = [];
            
            workingHours.forEach(hours => {
                const [startHour, startMinute] = hours.startTime.split(':').map(Number);
                const [endHour, endMinute] = hours.endTime.split(':').map(Number);
                
                let currentTime = new Date();
                currentTime.setHours(startHour, startMinute, 0);
                
                const endTime = new Date();
                endTime.setHours(endHour, endMinute, 0);
                
                while (currentTime < endTime) {
                    const slot = {
                        day: hours.day,
                        time: `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`
                    };
                    
                    availableSlots.push(slot);
                    
                    // Add appointment duration
                    currentTime.setMinutes(currentTime.getMinutes() + appointmentDuration);
                }
            });
            
            // Filter out slots that are already booked
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const confirmedAppointments = appointments.filter(app => app.status === 'confirmed');
            
            const filteredSlots = availableSlots.filter(slot => {
                return !confirmedAppointments.some(app => 
                    app.day === slot.day && app.time === slot.time
                );
            });
            
            // Save available slots to localStorage
            localStorage.setItem('availableSlots', JSON.stringify(filteredSlots));
        }
        
        // Load appointments
        function loadAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const pendingAppointments = appointments.filter(app => app.status === 'pending');
            const confirmedAppointments = appointments.filter(app => app.status === 'confirmed');
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            
            // Update counters
            document.getElementById('totalAppointments').textContent = appointments.length;
            document.getElementById('pendingAppointmentsCount').textContent = pendingAppointments.length;
            document.getElementById('pendingAppointmentsBadge').textContent = pendingAppointments.length;
            document.getElementById('pendingAppointmentsTabBadge').textContent = pendingAppointments.length;
            document.getElementById('upcomingAppointmentsCount').textContent = confirmedAppointments.length;
            document.getElementById('upcomingAppointmentsBadge').textContent = confirmedAppointments.length;
            document.getElementById('totalPatients').textContent = patients.length;
            
            // Load pending appointments
            const pendingList = document.getElementById('pendingAppointmentsList');
            pendingList.innerHTML = '';
            
            if (pendingAppointments.length === 0) {
                pendingList.innerHTML = `
                    <div class="empty-state">
                        <p>No pending appointments.</p>
                    </div>
                `;
            } else {
                pendingAppointments.forEach(appointment => {
                    const patient = patients.find(p => p.email === appointment.patientEmail);
                    
                    if (!patient) return;
                    
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Medical Issue:</strong> ${appointment.medicalIssue}</p>
                        <p><strong>Issue Started:</strong> ${appointment.issueStarted}</p>
                        <p><strong>Preferred Day:</strong> ${appointment.day}</p>
                        <p><strong>Preferred Time:</strong> ${formatTime(appointment.time)}</p>
                        <span class="status pending">Pending</span>
                        <div class="actions">
                            <button class="btn btn-sm" data-action="confirm" data-id="${appointment.id}">Confirm</button>
                            <button class="btn btn-sm btn-danger" data-action="reject" data-id="${appointment.id}">Reject</button>
                        </div>
                    `;
                    pendingList.appendChild(card);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.appointment-card .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const id = this.getAttribute('data-id');
                        
                        handleAppointmentAction(action, id);
                    });
                });
            }
            
            // Load upcoming appointments
            const upcomingList = document.getElementById('upcomingAppointmentsList');
            upcomingList.innerHTML = '';
            
            if (confirmedAppointments.length === 0) {
                upcomingList.innerHTML = `
                    <div class="empty-state">
                        <p>No upcoming appointments.</p>
                    </div>
                `;
            } else {
                confirmedAppointments.forEach(appointment => {
                    const patient = patients.find(p => p.email === appointment.patientEmail);
                    
                    if (!patient) return;
                    
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Medical Issue:</strong> ${appointment.medicalIssue}</p>
                        <p><strong>Issue Started:</strong> ${appointment.issueStarted}</p>
                        <p><strong>Appointment:</strong> ${appointment.day}, ${formatTime(appointment.time)}</p>
                        <span class="status confirmed">Confirmed</span>
                        <div class="actions">
                            <button class="btn btn-sm" data-action="startTreatment" data-id="${appointment.id}" data-patient="${patient.email}">Start Treatment</button>
                            <button class="btn btn-sm btn-danger" data-action="reschedule" data-id="${appointment.id}">Reschedule</button>
                        </div>
                    `;
                    upcomingList.appendChild(card);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('#upcomingAppointmentsList .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const id = this.getAttribute('data-id');
                        const patientEmail = this.getAttribute('data-patient');
                        
                        if (action === 'startTreatment') {
                            openTreatmentModal(id, patientEmail);
                        } else {
                            handleAppointmentAction(action, id);
                        }
                    });
                });
            }
            
            // Load patients in treatment
            loadPatientsInTreatment();
            
            // Load treated patients
            loadTreatedPatients();
        }
        
        // Handle appointment actions (confirm, reject, reschedule)
        function handleAppointmentAction(action, appointmentId) {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const index = appointments.findIndex(app => app.id === appointmentId);
            
            if (index === -1) return;
            
            switch (action) {
                case 'confirm':
                    appointments[index].status = 'confirmed';
                    // Remove this slot from available slots
                    updateAvailableSlots(appointments[index].day, appointments[index].time);
                    break;
                    
                case 'reject':
                    if (confirm('Are you sure you want to reject this appointment?')) {
                        appointments.splice(index, 1);
                    }
                    break;
                    
                case 'reschedule':
                    // For simplicity, just mark as pending again
                    appointments[index].status = 'pending';
                    break;
            }
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            loadAppointments();
        }
        
        // Update available slots after confirming an appointment
        function updateAvailableSlots(day, time) {
            const availableSlots = JSON.parse(localStorage.getItem('availableSlots') || '[]');
            const index = availableSlots.findIndex(slot => slot.day === day && slot.time === time);
            
            if (index !== -1) {
                availableSlots.splice(index, 1);
                localStorage.setItem('availableSlots', JSON.stringify(availableSlots));
            }
        }
        
        // Treatment Modal Functions
        const treatmentModal = document.getElementById('treatmentModal');
        const treatmentForm = document.getElementById('treatmentForm');
        const closeModalBtn = document.getElementById('closeModal');
        const saveTreatmentBtn = document.getElementById('saveTreatment');
        
        function openTreatmentModal(appointmentId, patientEmail) {
            document.getElementById('patientId').value = patientEmail;
            document.getElementById('appointmentId').value = appointmentId;
            
            // Clear form fields
            document.getElementById('diagnosis').value = '';
            document.getElementById('treatmentPlan').value = '';
            document.getElementById('recommendations').value = '';
            document.getElementById('medications').value = '';
            document.getElementById('followUpDate').value = '';
            
            // Show modal
            treatmentModal.classList.add('active');
        }
        
        closeModalBtn.addEventListener('click', function() {
            treatmentModal.classList.remove('active');
        });
        
        saveTreatmentBtn.addEventListener('click', function() {
            const patientEmail = document.getElementById('patientId').value;
            const appointmentId = document.getElementById('appointmentId').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const treatmentPlan = document.getElementById('treatmentPlan').value;
            const recommendations = document.getElementById('recommendations').value;
            const medications = document.getElementById('medications').value;
            const followUpDate = document.getElementById('followUpDate').value;
            
            if (!diagnosis || !treatmentPlan || !recommendations) {
                alert('Please fill out all required fields');
                return;
            }
            
            // Get patients in treatment
            const patientsInTreatment = JSON.parse(localStorage.getItem('patientsInTreatment') || '[]');
            
            // Check if patient is already in treatment
            const existingPatientIndex = patientsInTreatment.findIndex(p => p.email === patientEmail);
            
            if (existingPatientIndex !== -1) {
                // Add new treatment entry to existing patient
                patientsInTreatment[existingPatientIndex].treatments.push({
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    diagnosis,
                    treatmentPlan,
                    recommendations,
                    medications,
                    followUpDate
                });
            } else {
                // Get patient data
                const patients = JSON.parse(localStorage.getItem('patients') || '[]');
                const patient = patients.find(p => p.email === patientEmail);
                
                if (!patient) {
                    alert('Patient not found');
                    return;
                }
                
                // Add new patient in treatment
                patientsInTreatment.push({
                    email: patientEmail,
                    name: patient.name,
                    age: patient.age,
                    treatments: [{
                        id: Date.now().toString(),
                        date: new Date().toISOString(),
                        diagnosis,
                        treatmentPlan,
                        recommendations,
                        medications,
                        followUpDate
                    }]
                });
            }
            
            // Update patients in treatment
            localStorage.setItem('patientsInTreatment', JSON.stringify(patientsInTreatment));
            
            // Update appointment status
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
            
            if (appointmentIndex !== -1) {
                appointments.splice(appointmentIndex, 1);
                localStorage.setItem('appointments', JSON.stringify(appointments));
            }
            
            // Close modal
            treatmentModal.classList.remove('active');
            
            // Reload data
            loadAppointments();
            loadPatientsInTreatment();
        });
        
        // Load patients in treatment
        function loadPatientsInTreatment() {
            const patientsInTreatment = JSON.parse(localStorage.getItem('patientsInTreatment') || '[]');
            const inTreatmentList = document.getElementById('inTreatmentList');
            
            // Update counter
            document.getElementById('inTreatmentCount').textContent = patientsInTreatment.length;
            document.getElementById('inTreatmentBadge').textContent = patientsInTreatment.length;
            
            inTreatmentList.innerHTML = '';
            
            if (patientsInTreatment.length === 0) {
                inTreatmentList.innerHTML = `
                    <div class="empty-state">
                        <p>No patients currently in treatment.</p>
                    </div>
                `;
                return;
            }
            
            patientsInTreatment.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                
                let treatmentHistoryHTML = '';
                patient.treatments.forEach(treatment => {
                    const treatmentDate = new Date(treatment.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    treatmentHistoryHTML += `
                        <div class="treatment-entry">
                            <h4>Session on ${treatmentDate}</h4>
                            <p><strong>Diagnosis:</strong> ${treatment.diagnosis}</p>
                            <p><strong>Treatment Plan:</strong> ${treatment.treatmentPlan}</p>
                            <p><strong>Recommendations:</strong> ${treatment.recommendations}</p>
                            ${treatment.medications ? `<p><strong>Medications:</strong> ${treatment.medications}</p>` : ''}
                            ${treatment.followUpDate ? `<p><strong>Follow-up Date:</strong> ${new Date(treatment.followUpDate).toLocaleDateString()}</p>` : ''}
                            <p class="treatment-date">Created on ${treatmentDate}</p>
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <h3>${patient.name}</h3>
                    <div class="patient-info">
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Sessions:</strong> ${patient.treatments.length}</p>
                    </div>
                    <div class="treatment-history">
                        <h4>Treatment History</h4>
                        ${treatmentHistoryHTML}
                    </div>
                    <div class="actions">
                        <button class="btn" data-action="newSession" data-patient="${patient.email}">New Session</button>
                        <button class="btn" data-action="markTreated" data-patient="${patient.email}">Mark as Treated</button>
                    </div>
                `;
                
                inTreatmentList.appendChild(card);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('#inTreatmentList .btn[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const patientEmail = this.getAttribute('data-patient');
                    
                    if (action === 'newSession') {
                        // Create a new appointment for follow-up
                        createFollowUpAppointment(patientEmail);
                    } else if (action === 'markTreated') {
                        // Move patient to treated
                        markPatientAsTreated(patientEmail);
                    }
                });
            });
        }
        
        // Create follow-up appointment
        function createFollowUpAppointment(patientEmail) {
            // Get patient data
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            const patient = patients.find(p => p.email === patientEmail);
            
            if (!patient) {
                alert('Patient not found');
                return;
            }
            
            // For simplicity, we'll just create a pending appointment
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            const newAppointment = {
                id: Date.now().toString(),
                patientEmail,
                day: 'Monday', // Default day
                time: '09:00', // Default time
                medicalIssue: 'Follow-up appointment',
                issueStarted: 'N/A',
                status: 'pending',
                created: new Date().toISOString()
            };
            
            appointments.push(newAppointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            alert(`Follow-up appointment created for ${patient.name}. Please confirm the appointment time.`);
            loadAppointments();
        }
        
        // Mark patient as treated
        function markPatientAsTreated(patientEmail) {
            if (!confirm('Are you sure you want to mark this patient as treated? This will move them to the Treated section.')) {
                return;
            }
            
            // Get patients in treatment
            const patientsInTreatment = JSON.parse(localStorage.getItem('patientsInTreatment') || '[]');
            const patientIndex = patientsInTreatment.findIndex(p => p.email === patientEmail);
            
            if (patientIndex === -1) {
                alert('Patient not found');
                return;
            }
            
            const patient = patientsInTreatment[patientIndex];
            
            // Move to treated patients
            const treatedPatients = JSON.parse(localStorage.getItem('treatedPatients') || '[]');
            treatedPatients.push({
                ...patient,
                completedDate: new Date().toISOString()
            });
            
            // Remove from in treatment
            patientsInTreatment.splice(patientIndex, 1);
            
            // Save changes
            localStorage.setItem('patientsInTreatment', JSON.stringify(patientsInTreatment));
            localStorage.setItem('treatedPatients', JSON.stringify(treatedPatients));
            
            // Reload data
            loadPatientsInTreatment();
            loadTreatedPatients();
        }
        
        // Load treated patients
        function loadTreatedPatients() {
            const treatedPatients = JSON.parse(localStorage.getItem('treatedPatients') || '[]');
            const treatedList = document.getElementById('treatedList');
            
            // Update counter
            document.getElementById('treatedBadge').textContent = treatedPatients.length;
            
            treatedList.innerHTML = '';
            
            if (treatedPatients.length === 0) {
                treatedList.innerHTML = `
                    <div class="empty-state">
                        <p>No treated patients yet.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by completed date (most recent first)
            treatedPatients.sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            
            treatedPatients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                
                const completedDate = new Date(patient.completedDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let treatmentHistoryHTML = '';
                patient.treatments.forEach(treatment => {
                    const treatmentDate = new Date(treatment.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    treatmentHistoryHTML += `
                        <div class="treatment-entry">
                            <h4>Session on ${treatmentDate}</h4>
                            <p><strong>Diagnosis:</strong> ${treatment.diagnosis}</p>
                            <p><strong>Treatment Plan:</strong> ${treatment.treatmentPlan}</p>
                            <p><strong>Recommendations:</strong> ${treatment.recommendations}</p>
                            ${treatment.medications ? `<p><strong>Medications:</strong> ${treatment.medications}</p>` : ''}
                            ${treatment.followUpDate ? `<p><strong>Follow-up Date:</strong> ${new Date(treatment.followUpDate).toLocaleDateString()}</p>` : ''}
                            <p class="treatment-date">Created on ${treatmentDate}</p>
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <h3>${patient.name}</h3>
                    <div class="patient-info">
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Sessions:</strong> ${patient.treatments.length}</p>
                        <p><strong>Completed:</strong> ${completedDate}</p>
                    </div>
                    <div class="treatment-history">
                        <h4>Treatment History</h4>
                        ${treatmentHistoryHTML}
                    </div>
                    <div class="actions">
                        <button class="btn" data-action="newAppointment" data-patient="${patient.email}">New Appointment</button>
                    </div>
                `;
                
                treatedList.appendChild(card);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('#treatedList .btn[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const patientEmail = this.getAttribute('data-patient');
                    createFollowUpAppointment(patientEmail);
                });
            });
        }
        
        // Search functionality
        function setupSearch() {
            // Pending appointments search
            document.getElementById('pendingAppointmentsSearch').addEventListener('input', function() {
                filterAppointments('pending', this.value);
            });
            
            // Upcoming appointments search
            document.getElementById('upcomingAppointmentsSearch').addEventListener('input', function() {
                filterAppointments('upcoming', this.value);
            });
            
            // In treatment search
            document.getElementById('inTreatmentSearch').addEventListener('input', function() {
                filterPatients('inTreatment', this.value);
            });
            
            // Treated search
            document.getElementById('treatedSearch').addEventListener('input', function() {
                filterPatients('treated', this.value);
            });
        }
        
        // Filter appointments by search term
        function filterAppointments(type, searchTerm) {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            
            let filteredAppointments;
            if (type === 'pending') {
                filteredAppointments = appointments.filter(app => app.status === 'pending');
            } else {
                filteredAppointments = appointments.filter(app => app.status === 'confirmed');
            }
            
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredAppointments = filteredAppointments.filter(app => {
                    const patient = patients.find(p => p.email === app.patientEmail);
                    return patient && patient.name.toLowerCase().includes(searchTerm);
                });
            }
            
            // Update UI
            const listElement = document.getElementById(type === 'pending' ? 'pendingAppointmentsList' : 'upcomingAppointmentsList');
            listElement.innerHTML = '';
            
            if (filteredAppointments.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <p>No ${type} appointments found.</p>
                    </div>
                `;
                return;
            }
            
            filteredAppointments.forEach(appointment => {
                const patient = patients.find(p => p.email === appointment.patientEmail);
                
                if (!patient) return;
                
                const card = document.createElement('div');
                card.className = 'appointment-card';
                
                if (type === 'pending') {
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Medical Issue:</strong> ${appointment.medicalIssue}</p>
                        <p><strong>Issue Started:</strong> ${appointment.issueStarted}</p>
                        <p><strong>Preferred Day:</strong> ${appointment.day}</p>
                        <p><strong>Preferred Time:</strong> ${formatTime(appointment.time)}</p>
                        <span class="status pending">Pending</span>
                        <div class="actions">
                            <button class="btn btn-sm" data-action="confirm" data-id="${appointment.id}">Confirm</button>
                            <button class="btn btn-sm btn-danger" data-action="reject" data-id="${appointment.id}">Reject</button>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <p><strong>Age:</strong> ${patient.age}</p>
                        <p><strong>Medical Issue:</strong> ${appointment.medicalIssue}</p>
                        <p><strong>Issue Started:</strong> ${appointment.issueStarted}</p>
                        <p><strong>Appointment:</strong> ${appointment.day}, ${formatTime(appointment.time)}</p>
                        <span class="status confirmed">Confirmed</span>
                        <div class="actions">
                            <button class="btn btn-sm" data-action="startTreatment" data-id="${appointment.id}" data-patient="${patient.email}">Start Treatment</button>
                            <button class="btn btn-sm btn-danger" data-action="reschedule" data-id="${appointment.id}">Reschedule</button>
                        </div>
                    `;
                }
                
                listElement.appendChild(card);
            });
            
            // Re-add event listeners
            if (type === 'pending') {
                document.querySelectorAll('#pendingAppointmentsList .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const id = this.getAttribute('data-id');
                        
                        handleAppointmentAction(action, id);
                    });
                });
            } else {
                document.querySelectorAll('#upcomingAppointmentsList .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const id = this.getAttribute('data-id');
                        const patientEmail = this.getAttribute('data-patient');
                        
                        if (action === 'startTreatment') {
                            openTreatmentModal(id, patientEmail);
                        } else {
                            handleAppointmentAction(action, id);
                        }
                    });
                });
            }
        }
        
        // Filter patients by search term
        function filterPatients(type, searchTerm) {
            let patients;
            if (type === 'inTreatment') {
                patients = JSON.parse(localStorage.getItem('patientsInTreatment') || '[]');
            } else {
                patients = JSON.parse(localStorage.getItem('treatedPatients') || '[]');
            }
            
            let filteredPatients = patients;
            
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredPatients = patients.filter(patient => 
                    patient.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Update UI
            const listElement = document.getElementById(type === 'inTreatment' ? 'inTreatmentList' : 'treatedList');
            listElement.innerHTML = '';
            
            if (filteredPatients.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <p>No patients found.</p>
                    </div>
                `;
                return;
            }
            
            if (type === 'treated') {
                // Sort by completed date (most recent first)
                filteredPatients.sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            }
            
            filteredPatients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                
                let treatmentHistoryHTML = '';
                patient.treatments.forEach(treatment => {
                    const treatmentDate = new Date(treatment.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    treatmentHistoryHTML += `
                        <div class="treatment-entry">
                            <h4>Session on ${treatmentDate}</h4>
                            <p><strong>Diagnosis:</strong> ${treatment.diagnosis}</p>
                            <p><strong>Treatment Plan:</strong> ${treatment.treatmentPlan}</p>
                            <p><strong>Recommendations:</strong> ${treatment.recommendations}</p>
                            ${treatment.medications ? `<p><strong>Medications:</strong> ${treatment.medications}</p>` : ''}
                            ${treatment.followUpDate ? `<p><strong>Follow-up Date:</strong> ${new Date(treatment.followUpDate).toLocaleDateString()}</p>` : ''}
                            <p class="treatment-date">Created on ${treatmentDate}</p>
                        </div>
                    `;
                });
                
                if (type === 'inTreatment') {
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <div class="patient-info">
                            <p><strong>Age:</strong> ${patient.age}</p>
                            <p><strong>Sessions:</strong> ${patient.treatments.length}</p>
                        </div>
                        <div class="treatment-history">
                            <h4>Treatment History</h4>
                            ${treatmentHistoryHTML}
                        </div>
                        <div class="actions">
                            <button class="btn" data-action="newSession" data-patient="${patient.email}">New Session</button>
                            <button class="btn" data-action="markTreated" data-patient="${patient.email}">Mark as Treated</button>
                        </div>
                    `;
                } else {
                    const completedDate = new Date(patient.completedDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    card.innerHTML = `
                        <h3>${patient.name}</h3>
                        <div class="patient-info">
                            <p><strong>Age:</strong> ${patient.age}</p>
                            <p><strong>Sessions:</strong> ${patient.treatments.length}</p>
                            <p><strong>Completed:</strong> ${completedDate}</p>
                        </div>
                        <div class="treatment-history">
                            <h4>Treatment History</h4>
                            ${treatmentHistoryHTML}
                        </div>
                        <div class="actions">
                            <button class="btn" data-action="newAppointment" data-patient="${patient.email}">New Appointment</button>
                        </div>
                    `;
                }
                
                listElement.appendChild(card);
            });
            
            // Re-add event listeners
            if (type === 'inTreatment') {
                document.querySelectorAll('#inTreatmentList .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const patientEmail = this.getAttribute('data-patient');
                        
                        if (action === 'newSession') {
                            createFollowUpAppointment(patientEmail);
                        } else if (action === 'markTreated') {
                            markPatientAsTreated(patientEmail);
                        }
                    });
                });
            } else {
                document.querySelectorAll('#treatedList .btn[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const patientEmail = this.getAttribute('data-patient');
                        createFollowUpAppointment(patientEmail);
                    });
                });
            }
        }
        
        // Initialize application
        function init() {
            loadWorkingHours();
            generateAvailableSlots();
            loadAppointments();
            setupSearch();
        }
        
        // Run initialization
        init();
    </script>
</body>
</html>
